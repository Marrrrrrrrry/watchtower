#
# Builder
#

FROM golang:1.25-alpine AS builder

# use version (for example "v0.3.3") or "main"
ARG WATCHTOWER_VERSION=main
ARG RUN_TESTS=true

# Pre download required modules to avoid redownloading at each build thanks to docker layer caching.
# Copying go.mod and go.sum ensure to invalid the layer/build cache if there is a change in module requirement
WORKDIR /watchtower
COPY go.mod .
COPY go.sum .
RUN go mod download

# 安装构建所需工具与证书，保证静态链接与 TLS 可用
RUN apk add --no-cache \
    alpine-sdk \
    ca-certificates \
    git \
    tzdata

COPY . /watchtower

RUN \
  cd /watchtower && \
  \
  # 生成依赖锁并静态构建
  GO111MODULE=on go mod tidy && \
  GO111MODULE=on CGO_ENABLED=0 GOOS=linux go build -a -ldflags "-extldflags '-static' -X github.com/Marrrrrrrrry/watchtower/internal/meta.Version=${WATCHTOWER_VERSION}" . && \
  if [ "${RUN_TESTS}" = "true" ]; then GO111MODULE=on go test ./... -v; fi


#
# watchtower
#

FROM scratch

LABEL "com.centurylinklabs.watchtower"="true"

# 从 builder 阶段拷贝证书与时区数据，确保运行期 TLS/时区可用
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt
COPY --from=builder /usr/share/zoneinfo /usr/share/zoneinfo
COPY --from=builder /watchtower/watchtower /watchtower

HEALTHCHECK CMD [ "/watchtower", "--health-check"]

ENTRYPOINT ["/watchtower"]
